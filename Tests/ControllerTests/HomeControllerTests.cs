using System;
using System.Collections.Generic;
using System.Text;
using NUnit.Framework;
using TicketingSystem.Controllers;
using TicketingSystem.Models;
using System.Linq;
using Microsoft.AspNetCore.Mvc;
using System.Threading;
using System.Security.Principal;
using System.Security.Claims;
using Microsoft.AspNetCore.Http;
using TicketingSystem.Services;

namespace Tests.ControllerTests
{
    [TestFixture]
    class HomeControllerTests : Controller
    {
        HomeController hc;
        public HomeControllerTests()
        {
            Users dbUser;
            using (var db = new TicketingSystemDBContext())
            {
                dbUser = db.Users.Where(u => u.FullName == "Test User").First();
            }
            var user = new ClaimsPrincipal(new ClaimsIdentity(new Claim[]
            {
            new Claim(ClaimTypes.Name, dbUser.Auth0Uid)

            }, "mock"));

            hc = new HomeController();
            hc.ControllerContext = new ControllerContext
            {
                HttpContext = new DefaultHttpContext
                {
                    User = user
                }
            };
        }
        [Test]
        public void HomePageTest()
        {
            ViewResult result = (ViewResult)hc.HomePage();
            ViewResult testView = View("HomePage", "Home");

            Assert.IsNotNull(result);
            Assert.AreEqual(testView.ViewName, result.ViewName);
        }

        [Test]
        public void LandingTest()
        {
            ViewResult result = (ViewResult)hc.Landing();
            ViewResult testView = View("Landing", "Home");

            Assert.IsNotNull(result);
            Assert.AreEqual(testView.ViewName, result.ViewName);
        }

        [Test]
        public void DataEntryTest()
        {
            ViewResult result = (ViewResult)hc.DataEntry();
            ViewResult testView = View("DataEntry", "Home");

            Assert.IsNotNull(result);
            Assert.AreEqual(testView.ViewName, result.ViewName);
        }

        [Test]
        public void PostEntryTest()
        {
            using (var context = new TicketingSystemDBContext())
            {
                JobType j = new JobType();
                j.JobName = "Miscellaneous";

                RecordRetriever rr = new RecordRetriever();
                var records = rr.RetrieveRecords();

                TicketData td = new TicketData()
                {
                    TripNum = 111,
                    StageNum = "S01",
                    JobType = j,
                    EntryAuthor = context.Users.Where(u => u.FullName == "Test User").FirstOrDefault(),
                    TicketWorker = context.Users.Where(w => w.FullName == "Test User").FirstOrDefault(),
                    WorkerName = "Test User",
                    StartTime = DateTime.Now,
                    Comments = "Entry generated by HomeController.PostEntry unit test"
                };

                ViewResult result = (ViewResult)hc.PostEntry(td);
                ViewResult testView = View("HomePage", "Home");

                Assert.IsNotNull(result);
                Assert.AreEqual(testView.ViewData, result.ViewData);
                Assert.AreEqual(testView.ViewName, result.ViewName);
            }

        }
    }

}
